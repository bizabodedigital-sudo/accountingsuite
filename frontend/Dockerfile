# Use Debian-based Node image for better compatibility and full logs
FROM node:20-bullseye

# Enable verbose logging
ENV NPM_CONFIG_LOGLEVEL=verbose
ENV NEXT_TELEMETRY_DEBUG=1

# Fail-safe: Verify Dockerfile loaded
RUN echo "‚úÖ Dockerfile loaded successfully"

WORKDIR /app

# Fail-safe: Verify build context has files
RUN echo "üìÅ Checking build context..." && ls -la || echo "‚ùå Build context is empty!"

# Copy package.json and install dependencies first (for caching)
COPY package*.json ./
RUN echo "üì¶ Installing dependencies..." && \
    npm install --legacy-peer-deps

# Copy the rest of the app
COPY . .

# Fail-safe: Verify files were copied
RUN echo "üìÅ Files in build context:" && \
    ls -la && \
    echo "üìÅ Source files:" && \
    ls -la src/ 2>/dev/null || echo "‚ùå src/ directory missing!" && \
    echo "üìÅ Config files:" && \
    ls -la *.json *.ts *.mjs 2>/dev/null || echo "‚ö†Ô∏è Some config files missing"

# Set build-time environment variables (with defaults)
ARG NEXT_PUBLIC_API_URL=http://localhost:3001
ARG NEXT_PUBLIC_APP_URL=http://localhost:3000
ENV NEXT_PUBLIC_API_URL=$NEXT_PUBLIC_API_URL
ENV NEXT_PUBLIC_APP_URL=$NEXT_PUBLIC_APP_URL
ENV NODE_ENV=production

# Build the Next.js application
# Increase Node memory limit for build process
ENV NODE_OPTIONS="--max-old-space-size=4096"

# Debug: Verify Node and NPM are working
RUN echo "üîç Environment check:" && \
    echo "Node: $(node --version)" && \
    echo "NPM: $(npm --version)" && \
    echo "Working directory: $(pwd)" && \
    node -e "console.log('‚úÖ Node is working...')"

# Comprehensive pre-build diagnostic checks
RUN echo "üîç === PRE-BUILD DIAGNOSTICS ===" && \
    echo "" && \
    echo "üìã Configuration Files:" && \
    echo "  Next.js config: $(test -f next.config.ts && echo '‚úÖ YES' || echo '‚ùå NO')" && \
    echo "  PostCSS config: $(test -f postcss.config.mjs && echo '‚úÖ YES' || echo '‚ùå NO')" && \
    echo "  TypeScript config: $(test -f tsconfig.json && echo '‚úÖ YES' || echo '‚ùå NO')" && \
    echo "  Package.json: $(test -f package.json && echo '‚úÖ YES' || echo '‚ùå NO')" && \
    echo "" && \
    echo "üì¶ Dependencies Check:" && \
    echo "  Next.js installed: $(test -d node_modules/next && echo '‚úÖ YES' || echo '‚ùå NO')" && \
    echo "  React installed: $(test -d node_modules/react && echo '‚úÖ YES' || echo '‚ùå NO')" && \
    echo "  TypeScript installed: $(test -d node_modules/typescript && echo '‚úÖ YES' || echo '‚ùå NO')" && \
    echo "  Tailwind installed: $(test -d node_modules/tailwindcss && echo '‚úÖ YES' || echo '‚ùå NO')" && \
    echo "" && \
    echo "üìÅ Critical Directories:" && \
    echo "  src/ exists: $(test -d src && echo '‚úÖ YES' || echo '‚ùå NO')" && \
    echo "  src/app/ exists: $(test -d src/app && echo '‚úÖ YES' || echo '‚ùå NO')" && \
    echo "  public/ exists: $(test -d public && echo '‚úÖ YES' || echo '‚ùå NO')" && \
    echo "" && \
    echo "üîß Build Script:" && \
    cat package.json | grep -A 5 '"scripts"' && \
    echo "" && \
    echo "üåç Environment Variables:" && \
    echo "  NODE_ENV: $NODE_ENV" && \
    echo "  NEXT_PUBLIC_API_URL: $NEXT_PUBLIC_API_URL" && \
    echo "  NEXT_PUBLIC_APP_URL: $NEXT_PUBLIC_APP_URL" && \
    echo "  NODE_OPTIONS: $NODE_OPTIONS" && \
    echo "" && \
    echo "‚úÖ Pre-build checks complete"

# Run the build - let Next.js output go directly to stdout/stderr
RUN echo "üöÄ Starting Next.js build..." && \
    npm run build

# Expose the port Next.js runs on
EXPOSE 3000

# Start the production server
CMD ["npm", "start"]
